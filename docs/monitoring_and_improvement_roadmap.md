# クマップ - 監視設計と改善ロードマップ

**作成日**: 2025年12月8日  
**作成者**: Manus AI  
**対象期間**: 2025年～2030年（5年間）

---

## エグゼクティブサマリー

本レポートは、クマップの長期的な安定運用を実現するための監視設計と、今後5年間の改善ロードマップを提示するものである。監視設計では、**ログ収集**、**メトリクス監視**、**アラート設定**の3層構造を提案し、システムの健全性を継続的に把握する仕組みを構築する。改善ロードマップでは、短期（1年）、中期（2～3年）、長期（4～5年）の3段階に分けて、機能拡張とシステム強化の計画を示す。

---

## 1. 監視設計

### 1.1 監視の目的と原則

システム監視の目的は、以下の3点である：

1. **障害の早期検知**: システムの異常を迅速に検知し、ユーザーへの影響を最小限に抑える
2. **パフォーマンスの可視化**: システムのパフォーマンスを継続的に監視し、ボトルネックを特定する
3. **運用の効率化**: 自動化されたアラートにより、手動監視の負担を軽減する

監視設計の原則は、以下の通りである：

- **階層的な監視**: インフラ、アプリケーション、ビジネスメトリクスの3層で監視する
- **自動化**: 可能な限り監視とアラートを自動化し、人的コストを削減する
- **可視化**: ダッシュボードを用いて、システムの状態を一目で把握できるようにする

---

### 1.2 ログ収集

**目的**

アプリケーションの動作を詳細に記録し、障害発生時の原因究明を容易にする。

**収集対象**

以下のログを収集する：

1. **アプリケーションログ**: APIリクエスト、エラー、警告、デバッグ情報
2. **アクセスログ**: HTTPリクエストの詳細（URL、メソッド、ステータスコード、レスポンス時間）
3. **データベースログ**: スロークエリ、エラー、接続数
4. **スクレイピングログ**: スクレイピングの成功/失敗、取得件数、エラー詳細

**ログレベル**

以下のログレベルを使用する：

- **ERROR**: エラーが発生し、処理が失敗した場合
- **WARN**: 警告が発生したが、処理は継続できる場合
- **INFO**: 通常の動作情報（APIリクエスト、データベースクエリなど）
- **DEBUG**: デバッグ情報（開発環境のみ）

**ログフォーマット**

JSON形式でログを出力し、以下の情報を含める：

```json
{
  "timestamp": "2025-12-08T03:00:00.000Z",
  "level": "ERROR",
  "message": "Database connection failed",
  "context": {
    "userId": 123,
    "requestId": "abc-123",
    "error": {
      "code": "ECONNREFUSED",
      "message": "Connection refused"
    }
  }
}
```

**ログ収集ツール**

以下のツールを推奨する：

1. **Pino**: Node.js向けの高速ログライブラリ
2. **Winston**: 柔軟な設定が可能なログライブラリ
3. **Elasticsearch + Kibana**: ログの集約・検索・可視化（大規模運用時）
4. **Datadog Logs**: マネージドログ管理サービス（コスト効率が高い）

**実装例**

```typescript
import pino from 'pino';

const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  formatters: {
    level: (label) => {
      return { level: label.toUpperCase() };
    },
  },
  timestamp: pino.stdTimeFunctions.isoTime,
});

// Usage
logger.info({ userId: 123, action: 'login' }, 'User logged in');
logger.error({ error: err, requestId: 'abc-123' }, 'Database connection failed');
```

---

### 1.3 メトリクス監視

**目的**

システムのパフォーマンスと健全性を数値化し、継続的に監視する。

**監視対象メトリクス**

以下のメトリクスを監視する：

#### インフラメトリクス

| メトリクス | 説明 | 閾値（警告） | 閾値（重大） |
|-----------|------|------------|------------|
| CPU使用率 | サーバーのCPU使用率 | 70% | 90% |
| メモリ使用率 | サーバーのメモリ使用率 | 80% | 95% |
| ディスク使用率 | ディスクの使用率 | 80% | 90% |
| ネットワーク帯域幅 | 送受信データ量 | 80% | 95% |

#### アプリケーションメトリクス

| メトリクス | 説明 | 閾値（警告） | 閾値（重大） |
|-----------|------|------------|------------|
| APIレスポンス時間 | 平均レスポンス時間 | 1秒 | 3秒 |
| エラー率 | 5xx/4xxエラーの割合 | 1% | 5% |
| リクエスト数 | 1分あたりのリクエスト数 | - | - |
| 同時接続数 | 同時接続ユーザー数 | 1000 | 5000 |

#### データベースメトリクス

| メトリクス | 説明 | 閾値（警告） | 閾値（重大） |
|-----------|------|------------|------------|
| クエリ実行時間 | 平均クエリ実行時間 | 500ms | 2秒 |
| スロークエリ数 | 1秒以上かかるクエリ数 | 10件/分 | 50件/分 |
| 接続数 | データベース接続数 | 80% | 95% |
| デッドロック数 | デッドロック発生回数 | 1件/時 | 5件/時 |

#### ビジネスメトリクス

| メトリクス | 説明 | 閾値（警告） | 閾値（重大） |
|-----------|------|------------|------------|
| 出没情報投稿数 | 1時間あたりの投稿数 | - | - |
| スクレイピング成功率 | スクレイピングの成功率 | 90% | 80% |
| 通知配信成功率 | 通知配信の成功率 | 95% | 90% |
| アクティブユーザー数 | 1日あたりのアクティブユーザー数 | - | - |

**メトリクス収集ツール**

以下のツールを推奨する：

1. **Prometheus**: オープンソースのメトリクス収集・監視システム
2. **Grafana**: メトリクスの可視化ダッシュボード
3. **Datadog**: マネージド監視サービス（APM機能付き）
4. **New Relic**: アプリケーションパフォーマンス監視（APM）

**実装例**

```typescript
import { register, Counter, Histogram } from 'prom-client';

// Request counter
const httpRequestCounter = new Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'route', 'status'],
});

// Response time histogram
const httpRequestDuration = new Histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTP request duration in seconds',
  labelNames: ['method', 'route'],
  buckets: [0.1, 0.5, 1, 2, 5],
});

// Middleware
app.use((req, res, next) => {
  const start = Date.now();
  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;
    httpRequestCounter.inc({ method: req.method, route: req.route?.path, status: res.statusCode });
    httpRequestDuration.observe({ method: req.method, route: req.route?.path }, duration);
  });
  next();
});

// Metrics endpoint
app.get('/metrics', async (req, res) => {
  res.set('Content-Type', register.contentType);
  res.end(await register.metrics());
});
```

---

### 1.4 アラート設定

**目的**

システムの異常を迅速に検知し、担当者に通知する。

**アラートレベル**

以下の3段階のアラートレベルを設定する：

1. **INFO**: 情報通知（例: スクレイピング完了）
2. **WARNING**: 警告（例: CPU使用率70%超過）
3. **CRITICAL**: 重大（例: サービスダウン、エラー率5%超過）

**アラート通知先**

以下の通知先を設定する：

1. **Slack**: リアルタイム通知（全てのアラート）
2. **Email**: 重要なアラート（WARNING、CRITICAL）
3. **SMS**: 緊急アラート（CRITICALのみ）

**アラートルール例**

| アラート名 | 条件 | レベル | 通知先 |
|-----------|------|--------|--------|
| サービスダウン | HTTPステータスコード500が連続3回 | CRITICAL | Slack, Email, SMS |
| 高CPU使用率 | CPU使用率90%以上が5分継続 | CRITICAL | Slack, Email |
| スロークエリ検出 | クエリ実行時間2秒以上が10件/分 | WARNING | Slack |
| スクレイピング失敗 | スクレイピング成功率80%未満 | WARNING | Slack, Email |
| 通知配信失敗 | 通知配信成功率90%未満 | WARNING | Slack, Email |

**アラート設定ツール**

以下のツールを推奨する：

1. **Prometheus Alertmanager**: Prometheusと連携したアラート管理
2. **Grafana Alerts**: Grafanaダッシュボードからのアラート設定
3. **Datadog Monitors**: Datadogのアラート機能
4. **PagerDuty**: オンコール管理とアラートエスカレーション

---

### 1.5 ダッシュボード設計

**目的**

システムの状態を一目で把握できるダッシュボードを構築する。

**ダッシュボードの構成**

以下の3つのダッシュボードを作成する：

#### 1. システムヘルスダッシュボード

- サーバーのCPU、メモリ、ディスク使用率
- データベースの接続数、クエリ実行時間
- APIのレスポンス時間、エラー率
- スクレイピングの成功率、取得件数

#### 2. ビジネスメトリクスダッシュボード

- 出没情報投稿数（時間別、都道府県別）
- アクティブユーザー数（日別、週別、月別）
- 通知配信数（時間別、都道府県別）
- ページビュー数（ページ別）

#### 3. アラートダッシュボード

- 発生中のアラート一覧
- アラート履歴（過去24時間、過去7日間）
- アラート発生頻度（アラート種別ごと）

**ダッシュボード例（Grafana）**

```json
{
  "dashboard": {
    "title": "クマップ - システムヘルス",
    "panels": [
      {
        "title": "APIレスポンス時間",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"
          }
        ]
      },
      {
        "title": "エラー率",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m])"
          }
        ]
      }
    ]
  }
}
```

---

## 2. 改善ロードマップ

### 2.1 短期（1年目：2025年～2026年）

**目標**: システムの安定化と基本機能の充実

#### Q1（2025年1～3月）

**優先度S/Aのリファクタリング完了**

- 入力検証強化
- 管理者権限チェック実装
- データベースインデックス追加
- N+1クエリ問題解決
- トランザクションヘルパー・リトライヘルパー作成

**E2Eテスト実装**

- Bear Sightings APIのE2Eテスト
- Notification SystemのE2Eテスト
- テストカバレッジ80%達成

**CI/CD構築**

- GitHub Actions設定
- 自動テスト実行
- セキュリティスキャン

#### Q2（2025年4～6月）

**監視システム構築**

- ログ収集システム導入（Pino + Datadog Logs）
- メトリクス監視導入（Prometheus + Grafana）
- アラート設定（Slack, Email）

**パフォーマンス最適化**

- データベースクエリ最適化
- 通知配信の非同期化
- キャッシュ層導入（Redis）

**セキュリティ強化**

- 依存ライブラリのアップグレード（vite, mdast-util-to-hast）
- 入力サニタイゼーション強化
- HTTPS強制化

#### Q3（2025年7～9月）

**データソース多様化**

- 複数の都道府県公式サイトからのスクレイピング追加
- データソース監視システム導入
- スクレイピング失敗時のアラート設定

**ユーザー体験向上**

- マーカークラスタリング実装
- ページネーション実装
- モバイルUI最適化

#### Q4（2025年10～12月）

**機能拡張**

- ユーザープロフィール機能
- 投稿履歴表示
- お気に入り地域登録

**負荷テスト実施**

- データベース負荷テスト（10万件、100万件）
- API負荷テスト（同時接続数100、1000、10000）
- フロントエンド負荷テスト（Lighthouse）

---

### 2.2 中期（2～3年目：2026年～2028年）

**目標**: スケーラビリティの向上と高度な機能の追加

#### 2年目（2026年）

**スケーラビリティ向上**

- マイクロサービス化の検討
- データベースのシャーディング
- CDN導入（Cloudflare, AWS CloudFront）
- ロードバランサー導入

**高度な機能追加**

- AIによるクマ出没予測機能
- ヒートマップ表示
- 時系列分析ダッシュボード
- エクスポート機能（CSV, PDF）

**コミュニティ機能**

- ユーザー間のコメント機能
- 投稿の評価・レビュー機能
- ユーザーランキング

#### 3年目（2027年～2028年）

**多言語対応**

- 英語、中国語、韓国語対応
- 国際化（i18n）ライブラリ導入
- 多言語コンテンツ管理

**API公開**

- 公開API提供（REST API, GraphQL）
- API認証・レート制限
- APIドキュメント（Swagger, Redoc）

**モバイルアプリ開発**

- iOS/Androidアプリ開発（React Native）
- プッシュ通知機能
- オフライン対応

---

### 2.3 長期（4～5年目：2028年～2030年）

**目標**: エコシステムの構築と社会的インパクトの拡大

#### 4年目（2028年～2029年）

**エコシステム構築**

- サードパーティ開発者向けSDK提供
- プラグインシステム
- マーケットプレイス

**自治体・研究機関との連携**

- 公式データ提供契約の締結
- 研究機関へのデータ提供
- 自治体向けダッシュボード提供

**AI/機械学習の高度化**

- 画像認識によるクマ種別判定
- 自然言語処理による投稿内容分析
- 異常検知システム（スパム、誤情報）

#### 5年目（2029年～2030年）

**社会的インパクトの拡大**

- 他の野生動物への対応拡大（イノシシ、シカなど）
- 災害情報との統合（地震、台風など）
- 国際展開（北米、ヨーロッパ）

**持続可能な運用体制**

- 収益化モデルの確立（広告、サブスクリプション、自治体契約）
- オープンソース化の検討
- コミュニティ主導の運営体制

---

## 3. コスト見積もり

以下の表は、各フェーズにおける推定コストを示している。

| フェーズ | 期間 | 人件費 | インフラ費 | その他 | 合計 |
|---------|------|--------|-----------|--------|------|
| 短期（1年目） | 2025～2026 | ¥6,000,000 | ¥600,000 | ¥400,000 | ¥7,000,000 |
| 中期（2～3年目） | 2026～2028 | ¥15,000,000 | ¥2,400,000 | ¥1,600,000 | ¥19,000,000 |
| 長期（4～5年目） | 2028～2030 | ¥20,000,000 | ¥4,000,000 | ¥3,000,000 | ¥27,000,000 |
| **合計** | **5年間** | **¥41,000,000** | **¥7,000,000** | **¥5,000,000** | **¥53,000,000** |

**コスト内訳の説明**

- **人件費**: 開発者、デザイナー、プロジェクトマネージャーの人件費
- **インフラ費**: サーバー、データベース、CDN、監視ツールの費用
- **その他**: マーケティング、法務、ライセンス費用など

---

## 4. KPI（重要業績評価指標）

以下のKPIを設定し、定期的に評価する。

### 4.1 技術KPI

| KPI | 目標値（1年目） | 目標値（3年目） | 目標値（5年目） |
|-----|---------------|---------------|---------------|
| システム稼働率 | 99.5% | 99.9% | 99.95% |
| 平均レスポンス時間 | <1秒 | <500ms | <300ms |
| エラー率 | <1% | <0.5% | <0.1% |
| テストカバレッジ | 80% | 90% | 95% |
| セキュリティ脆弱性数 | 0件（高以上） | 0件（中以上） | 0件 |

### 4.2 ビジネスKPI

| KPI | 目標値（1年目） | 目標値（3年目） | 目標値（5年目） |
|-----|---------------|---------------|---------------|
| 月間アクティブユーザー数 | 10,000人 | 100,000人 | 500,000人 |
| 出没情報投稿数 | 1,000件/月 | 10,000件/月 | 50,000件/月 |
| 通知配信数 | 5,000件/月 | 50,000件/月 | 250,000件/月 |
| ユーザー満足度 | 4.0/5.0 | 4.5/5.0 | 4.8/5.0 |
| 自治体連携数 | 5自治体 | 20自治体 | 47都道府県 |

---

## 5. リスクと対策

### 5.1 技術的リスク

**リスク**: 技術的負債の蓄積により、開発速度が低下する

**対策**: 定期的なリファクタリング、コードレビューの徹底、技術的負債の可視化

### 5.2 ビジネスリスク

**リスク**: ユーザー数が想定を下回り、収益化が困難になる

**対策**: マーケティング強化、ユーザーフィードバックの収集、機能改善の継続

### 5.3 法的リスク

**リスク**: スクレイピングが法的問題を引き起こす

**対策**: データ提供元との正式契約、利用規約の確認、法務相談

---

## 6. 結論

本レポートでは、クマップの長期的な安定運用を実現するための監視設計と、今後5年間の改善ロードマップを提示した。監視設計では、ログ収集、メトリクス監視、アラート設定の3層構造を提案し、システムの健全性を継続的に把握する仕組みを構築する。改善ロードマップでは、短期（1年）、中期（2～3年）、長期（4～5年）の3段階に分けて、機能拡張とシステム強化の計画を示した。

特に、短期では**システムの安定化と基本機能の充実**に注力し、中期では**スケーラビリティの向上と高度な機能の追加**を実現し、長期では**エコシステムの構築と社会的インパクトの拡大**を目指す。これらの計画を着実に実行することで、クマップは日本全国のクマ出没情報を網羅する、信頼性の高いプラットフォームとして成長することができる。

---

**作成者**: Manus AI  
**最終更新**: 2025年12月8日
