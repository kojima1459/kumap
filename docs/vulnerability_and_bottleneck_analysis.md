# クマップ - ライブラリ脆弱性調査とボトルネック分析レポート

**作成日**: 2025年12月8日  
**作成者**: Manus AI  
**スキャン実行日**: 2025年12月8日

---

## エグゼクティブサマリー

本レポートは、クマップのライブラリ依存関係における脆弱性調査と、高負荷時のパフォーマンスボトルネック分析を実施したものである。脆弱性スキャンの結果、**6件の中程度の脆弱性**が検出された。これらは全て開発環境に関連するものであり、本番環境への直接的な影響は限定的である。ボトルネック分析では、**データベースクエリ**、**通知配信**、**スクレイピング処理**の3つが高負荷時のパフォーマンス低下の主要因として識別された。

---

## 1. ライブラリ脆弱性調査

### 1.1 スキャン概要

**スキャン方法**: `pnpm audit`コマンドを使用  
**スキャン対象**: 全依存ライブラリ（直接依存・間接依存を含む）  
**検出された脆弱性数**: 6件（全て中程度）

### 1.2 検出された脆弱性の詳細

#### 脆弱性 #1: esbuild - CORS設定の不備

**パッケージ**: esbuild  
**脆弱性ID**: GHSA-67mh-4wv8-2f99  
**深刻度**: 中程度（Moderate）  
**CVSS スコア**: 5.3  
**影響を受けるバージョン**: <=0.24.2  
**修正バージョン**: >=0.25.0

**脆弱性の詳細**

esbuildの開発サーバーは、デフォルトで`Access-Control-Allow-Origin: *`ヘッダーを全てのリクエストに設定している。これにより、任意のWebサイトが開発サーバーにリクエストを送信し、レスポンスを読み取ることが可能となる。攻撃者は、悪意のあるWebページを用意し、ユーザーがそのページにアクセスした際に、開発サーバーからソースコードを窃取することができる。

**影響範囲**

本脆弱性は、**開発環境のみ**に影響する。本番環境では、esbuildの開発サーバーは使用されないため、直接的な影響はない。ただし、開発者のローカル環境でソースコードが漏洩するリスクがある。

**対策**

- esbuildを0.25.0以降にアップグレードする
- 開発サーバーをローカルホスト以外に公開しない（`--host`オプションを使用しない）
- ファイアウォールで開発サーバーへの外部アクセスをブロックする

**現在の状況**

プロジェクトでは、esbuild 0.18.20および0.21.5が間接依存として使用されている。これらは、drizzle-kitおよびvitestの依存関係として含まれている。

**推奨アクション**: drizzle-kitおよびvitestを最新バージョンにアップグレードし、間接依存のesbuildも更新する。

---

#### 脆弱性 #2 & #3: vite - server.fs.denyバイパス（Windows）

**パッケージ**: vite  
**脆弱性ID**: GHSA-93m4-6634-74q7  
**CVE**: CVE-2025-62522  
**深刻度**: 中程度（Moderate）  
**影響を受けるバージョン**: 5.2.6～5.4.20、7.1.0～7.1.10  
**修正バージョン**: 5.4.21以降、7.1.11以降

**脆弱性の詳細**

Viteの開発サーバーは、`server.fs.deny`設定により、特定のファイル（`.env`、証明書ファイルなど）へのアクセスを制限している。しかし、Windows環境において、URLの末尾にバックスラッシュ（`\`）を付加することで、この制限をバイパスできる脆弱性が存在する。攻撃者は、`/.env\`のようなリクエストを送信することで、本来アクセスできないファイルを取得できる。

**影響範囲**

本脆弱性は、以下の条件を全て満たす場合にのみ影響する：

1. 開発サーバーをネットワークに公開している（`--host`オプションまたは`server.host`設定を使用）
2. Windows環境で開発サーバーを実行している

Linux/macOS環境では影響を受けない。また、本番環境では開発サーバーは使用されないため、直接的な影響はない。

**対策**

- viteを5.4.21以降または7.1.11以降にアップグレードする
- 開発サーバーをネットワークに公開しない
- Windows環境での開発時は、特に注意を払う

**現在の状況**

プロジェクトでは、vite 5.4.20および7.1.9が使用されている。これらは脆弱性の影響を受けるバージョンである。

**推奨アクション**: viteを最新バージョンにアップグレードする。

---

#### 脆弱性 #4: tar - 無限ループによるDoS

**パッケージ**: tar  
**脆弱性ID**: GHSA-29xp-372q-xqph  
**CVE**: CVE-2025-64118  
**深刻度**: 中程度（Moderate）  
**影響を受けるバージョン**: <7.5.2  
**修正バージョン**: >=7.5.2

**脆弱性の詳細**

tarパッケージに、特定の条件下で無限ループに陥る脆弱性が存在する。攻撃者は、細工されたtarアーカイブを提供することで、サーバーをDoS状態にすることができる。

**影響範囲**

tarパッケージは、@tailwindcss/oxideの依存関係として使用されている。Tailwind CSSのビルドプロセスで使用されるため、悪意のあるtarアーカイブが処理されることは通常ない。影響は限定的である。

**対策**

- tarパッケージを7.5.2以降にアップグレードする

**推奨アクション**: @tailwindcss/oxideを最新バージョンにアップグレードする。

---

#### 脆弱性 #5: mdast-util-to-hast - XSS脆弱性

**パッケージ**: mdast-util-to-hast  
**脆弱性ID**: GHSA-4fh9-h7wg-q85m  
**深刻度**: 中程度（Moderate）  
**影響を受けるバージョン**: 13.0.0～13.2.0  
**修正バージョン**: >=13.2.1

**脆弱性の詳細**

mdast-util-to-hastパッケージに、特定の条件下でXSS攻撃を許す脆弱性が存在する。このパッケージは、Markdownを HTML に変換する際に使用される。攻撃者は、細工されたMarkdownを提供することで、任意のJavaScriptを実行できる可能性がある。

**影響範囲**

mdast-util-to-hastは、streamdownパッケージの依存関係として使用されている。streamdownは、LLMの応答をMarkdownとしてレンダリングする際に使用される。ユーザーが投稿したMarkdownをレンダリングする場合、XSS攻撃のリスクがある。

**対策**

- mdast-util-to-hastを13.2.1以降にアップグレードする
- ユーザー入力のMarkdownをレンダリングする際は、適切なサニタイゼーションを実施する

**推奨アクション**: streamdownを最新バージョンにアップグレードする。

---

### 1.3 脆弱性の総合評価

| パッケージ | 脆弱性ID | 深刻度 | 本番環境への影響 | 対策優先度 |
|-----------|---------|--------|----------------|-----------|
| esbuild | GHSA-67mh-4wv8-2f99 | 中 | なし（開発環境のみ） | 中 |
| vite | GHSA-93m4-6634-74q7 | 中 | なし（開発環境のみ） | 中 |
| tar | GHSA-29xp-372q-xqph | 中 | 低（ビルド時のみ） | 低 |
| mdast-util-to-hast | GHSA-4fh9-h7wg-q85m | 中 | 中（XSSリスク） | 高 |

**総合評価**: 検出された脆弱性は全て中程度であり、本番環境への直接的な影響は限定的である。ただし、mdast-util-to-hastのXSS脆弱性は、ユーザー投稿機能を持つアプリケーションにおいて潜在的なリスクとなる。早期のアップグレードが推奨される。

---

## 2. パフォーマンスボトルネック分析

### 2.1 分析手法

以下の手法を用いて、高負荷時のパフォーマンスボトルネックを分析した：

1. **コードレビュー**: データベースクエリ、API呼び出し、ループ処理などを精査
2. **E2Eテスト結果**: テスト実行時間から処理時間を推定
3. **アーキテクチャ分析**: システム全体の構成から潜在的なボトルネックを特定

### 2.2 識別されたボトルネック

#### ボトルネック #1: データベースクエリのパフォーマンス

**問題の詳細**

地図上のマーカー表示時に実行される`bearSightings.list`クエリは、フィルタリング条件によっては大量のレコードをスキャンする。現在、以下のインデックスが設定されている：

- prefecture（単独インデックス）
- sightedAt（単独インデックス）
- sourceType（単独インデックス）
- status（単独インデックス）
- (prefecture, sightedAt)（複合インデックス）

しかし、複数の条件を組み合わせたクエリ（例: prefecture + sourceType + status）では、インデックスが十分に活用されない可能性がある。

**影響度**

ユーザー数が増加し、データベースのレコード数が10万件を超えると、クエリ応答時間が1秒を超える可能性がある。これにより、ページ読み込み時間が遅延し、ユーザー体験が悪化する。

**対策提案**

1. **クエリ実行計画の分析**: `EXPLAIN`コマンドを使用して、実際のクエリ実行計画を確認し、インデックスが適切に使用されているかを検証する
2. **追加の複合インデックス**: 頻繁に使用されるクエリパターンに対して、複合インデックスを追加する（例: (prefecture, sourceType, status)）
3. **ページネーション**: 一度に取得するレコード数を制限し、ページネーションを実装する
4. **キャッシュ層の導入**: Redisを使用して、頻繁にアクセスされるクエリ結果をキャッシュする

**推定される改善効果**: クエリ応答時間を50～80%削減

---

#### ボトルネック #2: 通知配信の同期処理

**問題の詳細**

現在の通知配信システムは、同期的に通知を送信している。1件の出没情報に対して、購読者全員に通知を送信する処理が、APIリクエストのレスポンス時間に含まれる。購読者が100人いる場合、通知送信に数秒～数十秒かかる可能性がある。

**影響度**

通知配信の遅延により、APIレスポンス時間が大幅に増加する。最悪の場合、タイムアウトが発生し、出没情報の投稿自体が失敗する可能性がある。

**対策提案**

1. **非同期化**: メッセージキュー（RabbitMQ、AWS SQS、Redis Pub/Subなど）を導入し、通知をバックグラウンドで処理する
2. **バッチ処理**: 複数の通知をまとめて送信することで、API呼び出し回数を削減する
3. **レート制限**: 通知送信のレート制限を設定し、外部APIへの負荷を制御する

**推定される改善効果**: APIレスポンス時間を90%以上削減（通知処理がバックグラウンドに移行するため）

---

#### ボトルネック #3: スクレイピング処理の直列実行

**問題の詳細**

現在のスクレイピング処理は、都道府県ごとに直列で実行されている。全ての都道府県をスクレイピングする場合、処理時間が数分に及ぶ可能性がある。また、スクレイピング中にエラーが発生した場合、リトライ処理により処理時間がさらに延長される。

**影響度**

スクレイピング処理が長時間実行されると、サーバーリソースが占有され、他のリクエストの処理が遅延する。また、スクレイピング処理中にサーバーが再起動すると、処理が中断され、データの取得が不完全になる可能性がある。

**対策提案**

1. **並列処理**: 複数の都道府県を並列でスクレイピングすることで、処理時間を短縮する
2. **バックグラウンドジョブ**: スクレイピング処理をバックグラウンドジョブとして実行し、定期的に自動実行する（cronジョブまたはワーカープロセス）
3. **進捗管理**: スクレイピングの進捗をデータベースに記録し、中断された場合でも再開できるようにする

**推定される改善効果**: スクレイピング処理時間を60～80%削減

---

#### ボトルネック #4: フロントエンドのマーカー描画

**問題の詳細**

地図上に大量のマーカーを表示する場合、ブラウザのレンダリング処理が重くなる。1000件以上のマーカーを表示すると、ページの応答性が低下し、スクロールやズーム操作が遅延する可能性がある。

**影響度**

ユーザー体験が悪化し、特にモバイルデバイスでは顕著な遅延が発生する。

**対策提案**

1. **マーカークラスタリング**: 近接するマーカーをグループ化し、クラスターとして表示する（Google Maps Marker Clusteringライブラリを使用）
2. **表示件数の制限**: 一度に表示するマーカー数を制限し、ズームレベルに応じて表示するマーカーを調整する
3. **遅延読み込み**: 地図の表示範囲内のマーカーのみを読み込み、スクロール時に追加読み込みを行う

**推定される改善効果**: 大量マーカー表示時のレンダリング時間を70～90%削減

---

### 2.3 負荷テストの推奨

上記のボトルネック分析は、コードレビューとアーキテクチャ分析に基づくものである。実際の高負荷環境でのパフォーマンスを正確に評価するため、以下の負荷テストを実施することを推奨する：

1. **データベース負荷テスト**: 10万件、100万件のレコードを投入し、クエリ応答時間を測定
2. **API負荷テスト**: Apache JMeterやk6を使用して、同時接続数100、1000、10000の条件下でAPIレスポンス時間を測定
3. **フロントエンド負荷テスト**: Lighthouseを使用して、大量マーカー表示時のページパフォーマンスを測定

---

## 3. 対策の優先順位と実装ロードマップ

| 対策項目 | 優先度 | 推定工数 | 実施時期 | 期待効果 |
|---------|--------|---------|---------|---------|
| mdast-util-to-hastのアップグレード | 高 | 1日 | 即時 | XSSリスク軽減 |
| viteのアップグレード | 中 | 1日 | 1週間以内 | 開発環境のセキュリティ向上 |
| 通知配信の非同期化 | 高 | 5日 | 1ヶ月以内 | APIレスポンス時間90%削減 |
| データベースクエリ最適化 | 高 | 3日 | 1ヶ月以内 | クエリ応答時間50～80%削減 |
| マーカークラスタリング | 中 | 3日 | 2ヶ月以内 | レンダリング時間70～90%削減 |
| スクレイピング並列化 | 中 | 5日 | 2ヶ月以内 | スクレイピング時間60～80%削減 |
| esbuildのアップグレード | 低 | 1日 | 3ヶ月以内 | 開発環境のセキュリティ向上 |
| 負荷テスト実施 | 中 | 3日 | 3ヶ月以内 | ボトルネックの正確な特定 |

---

## 4. 結論

ライブラリ脆弱性調査の結果、6件の中程度の脆弱性が検出されたが、本番環境への直接的な影響は限定的である。ただし、mdast-util-to-hastのXSS脆弱性は早期に対処すべきである。ボトルネック分析では、データベースクエリ、通知配信、スクレイピング処理が高負荷時のパフォーマンス低下の主要因として識別された。これらの対策を実施することで、システムの安定性とパフォーマンスが大幅に向上する。

特に、通知配信の非同期化とデータベースクエリ最適化は、ユーザー体験に直接影響するため、最優先で実施すべきである。また、定期的な負荷テストを実施し、実際の高負荷環境でのパフォーマンスを継続的に監視することが重要である。

---

**作成者**: Manus AI  
**最終更新**: 2025年12月8日
