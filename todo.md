# Bear Map App - TODO

## データベース設計
- [x] クマ出没情報テーブル（bear_sightings）の作成
- [x] データソース区別（公式/ユーザー投稿）
- [x] 都道府県・市町村情報の管理

## バックエンドAPI
- [x] クマ出没情報取得API（地域フィルタリング対応）
- [x] ユーザー投稿API（認証必須）
- [x] 管理者承認API（オプション）

## スクレイピング機能
- [x] Yahoo!ニュースのクマ出没情報ページのスクレイピング
- [x] 各都道府県の公式サイトへのリンク抽出
- [ ] 定期実行機能（cron/scheduled task）

## Googleマップ統合
- [x] Googleマップコンポーネントの実装
- [x] マーカー表示（公式情報とユーザー投稿を区別）
- [x] 情報ウィンドウ（詳細表示）
- [x] 地域別フィルタリング

## ユーザー投稿機能
- [x] 投稿フォーム（位置情報、日時、詳細）
- [ ] 画像アップロード機能
- [ ] 投稿一覧表示
- [ ] 投稿編集・削除機能

## UI/UX
- [x] レスポンシブデザイン
- [x] ローディング状態の実装
- [x] エラーハンドリング
- [x] 地域選択UI

## テスト
- [x] バックエンドAPIのテスト
- [x] スクレイピング機能のテスト
- [ ] フロントエンドのテスト

## 定期実行機能（追加要望）
- [x] 毎日自動でYahoo!ニュースをスクレイピング
- [x] スケジュール設定（毎日特定時刻に実行）
- [x] 重複データの排除ロジック
- [x] スクレイピング結果のログ記録
- [x] 管理者用の手動実行ページ

## 日付フィルター機能（追加要望）
- [x] 日付範囲フィルター（過去1週間、1ヶ月、3ヶ月、全期間）
- [x] マーカーに日時情報を表示
- [x] 情報ウィンドウに詳細な日時表示
- [x] 投稿日時と目撃日時の区別

## 京都府詳細データ追加（追加要望）
- [ ] 京都府GISサイトからの詳細データスクレイピング
- [ ] 具体的な位置情報（緯度経度）の取得
- [ ] 既存スクレイピング機能への統合

## ハイブリッド方式の実装（追加要望）
- [x] Yahoo!ニュースから各都道府県の外部リンクを抽出
- [x] 都道府県別の外部リンクをデータベースに保存
- [x] マップ上で「詳細を見る」ボタンから外部リンクへ誘導
- [ ] 京都府GISデータの詳細スクレイピング（特別対応）
- [ ] 取得しやすい都道府県の追加対応（オプション）

## 正確なURLマッピング（追加要望）
- [x] ユーザー提供の正確な都道府県マップURLをデータベースに反映
- [x] 既存のスクレイピング結果を更新
- [x] URL精度の向上確認

## 通知機能（追加要望）
- [x] ユーザー通知設定テーブルの作成
- [x] 都道府県・地域別の通知設定UI
- [x] 新規出没情報追加時の通知トリガー
- [x] メール通知送信機能（Manus通知API使用）
- [x] 通知設定管理ページ
- [x] 通知履歴の記録

## バグ修正（ユーザー報告）
- [x] Google Maps API重複読み込みエラーの修正（/submitページ）

## 地図上の都道府県別統計表示（追加要望）
- [x] 都道府県別の出没件数集計API
- [x] 地図上に都道府県別の出没件数を表示
- [x] 都道府県をクリックして詳細統計を表示

## Playwright MCPを使用した都道府県別詳細スクレイピング（追加要望）
- [ ] Playwright MCPの初期設定とブラウザインストール
- [ ] 京都府GISデータのスクレイピング実装
- [ ] 北海道ひぐまっぷのスクレイピング実装
- [ ] Google My Maps形式のスクレイピング実装（鳥取、静岡など）
- [ ] ArcGIS Dashboard形式のスクレイピング実装（埼玉、群馬、新潟など）
- [ ] 毎日午前3時の自動実行スケジュール設定
- [ ] エラーハンドリングとリトライロジック

## 都道府県別公式マップリンク表示（追加要望）
- [x] 統計マップの都道府県マーカーに公式リンクを追加
- [x] 「詳細はこちらでも確認できます」メッセージの表示
- [x] 20都道府県の公式URLを統計情報ウィンドウに表示

## メインマップへの公式リンク追加（追加要望）
- [x] MapViewページの情報ウィンドウに都道府県別公式リンクを追加
- [x] 各マーカーのポップアップに「詳細はこちらでも確認できます」メッセージを表示

## マーケティング・ブランディング（追加要望）
- [x] X（Twitter）宣伝文章3パターン作成
- [x] Manusキャンペーン応募文作成
- [x] 広告画像3枚生成
- [x] ロゴ画像生成
- [x] サイト名を「クマップ」に変更
- [x] フッター追加（製作者・問い合わせ・寄付先情報）

## コードレビュー・リファクタリング（追加要望）
- [x] 包括的コードレビューの実施
- [x] 入力検証の強化（緯度経度範囲、都道府県リスト、文字数制限）
- [x] 管理者権限チェックの実装（adminProcedure作成）
- [x] データベースインデックスの追加（prefecture, sightedAt, sourceType, status + 複合インデックス）
- [x] 共通定数ファイルの作成（PREFECTURES, VALIDATION, BEAR_TYPES）
- [x] リトライヘルパーの作成（指数バックオフ、エラーハンドリング）
- [x] N+1クエリ問題の解決（JOINを使用した通知機能の最適化）
- [x] トランザクションヘルパーの作成
- [x] 環境変数管理ドキュメントの作成
- [x] README.mdの拡充
- [ ] スクレイピングロジックへのリトライ適用
- [ ] フロントエンドコンポーネントの分割（MapView, StatsMapView）
- [ ] フロントエンドエラー表示の改善
- [ ] E2Eテストの実装
- [ ] GitHub Actions CI/CD設定

- [x] スクレイピングロジックへのリトライ適用
- [x] MapFilterコンポーネントの分離
- [x] BearMarkerコンポーネントの作成
- [x] MapView.tsxのリファクタリング

- [x] E2Eテストコードの生成と実装（24テスト全てパス）
- [x] GitHub Actions CI/CD設定（lint, typecheck, unit tests, e2e tests, build, security scan）

## セキュリティアップグレード（追加要望）
- [x] viteを最新バージョンにアップグレード（脆弱性解消）
- [x] streamdownを最新バージョンにアップグレード（mdast-util-to-hastのXSS脆弱性解消）
- [x] アップグレード後のテスト実行と動作確認（脆弱性50%削減）

## マーカークラスタリング実装（追加要望）
- [x] Google Maps Marker Clusteringライブラリの調査と選定（@googlemaps/markerclusterer v2.6.2）
- [x] マーカークラスタリングの実装
- [x] クラスターのスタイリング（色、サイズ、アイコン）
- [x] クラスタークリック時の動作実装（ズームイン）
- [x] パフォーマンステスト（8テスト全て合格、74.5%のマーカー削減を達成）
- [x] パフォーマンステスト結果レポート作成

## 管理機能のオーナー専用化（セキュリティ・コスト対策）
- [x] バックエンドに管理者権限チェックを実装（scraper.runScraperをadminProcedureに変更）
- [x] adminProcedureをOWNER_OPEN_IDチェックに変更（roleチェックからopenIdチェックに）
- [x] VITE_OWNER_OPEN_ID環境変数を追加（フロントエンド用）
- [x] フロントエンドで管理ボタンをオーナー専用に制限（MapView.tsx）
- [x] AdminScraperページへのアクセス制限（オーナー以外はアクセス拒否画面表示）
- [x] オーナー専用アクセス制御のテスト作成（10テスト全て合格）

## 都道府県別詳細スクレイピング機能（追加要望）
- [x] 都道府県公式サイトの構造調査（3都道府県：岩手・秋田・長野）
- [x] 優先度の高い都道府県を選定（出没件数が多い地域）
- [x] Playwright MCPのセットアップと動作確認
- [x] pdfplumberのインストールと設定
- [x] 長野県PDF解析スクリプト作成（19件抽出成功）
- [x] geocoding機能実装（Google Maps API使用）
- [x] データベースインポートスクリプト作成
- [x] 長野県データのインポート（19件成功、合計160件）
- [x] マップ上でデータ表示確認
- [ ] 岩手県PDF解析実装（後回し：PDFに詳細データなし）
- [ ] 秋田県PDF解析実装（後回し：Kumadasシステムの複雑なスクレイピングが必要）
- [x] データ正規化ロジック実装（日時・場所・緯度経度の統一フォーマット）
- [x] 重複データ排除ロジック実装
- [x] 自動実行スケジュールの設定（既存のYahoo!スクレイピングと統合）
- [x] エラーハンドリングとリトライロジック実装
- [x] テスト実装と動作確認

## 長野県PDF自動スクレイピング・重複排除実装（追加要望）
- [x] 長野県PDF自動スクレイピングスクリプト作成（server/prefectureScraper.ts）
- [x] 長野県PDFダウンロード機能実装
- [x] 長野県PDF解析機能実装（Python pdfplumber使用）
- [x] 長野県データインポート機能実装（geocoding統合）
- [x] 重複データ排除ロジック実装（server/deduplication.ts）
- [x] 重複チェック機能実装（都道府県+市町村+日付、緯度経度+日付、sourceUrl）
- [x] 既存重複データ検出機能実装
- [x] 重複データ削除機能実装
- [x] 長野県PDF自動スクレイピングのスケジュール設定（毎日午前2時）
- [x] scraperRouterに長野県スクレイパー追加（runNaganoScraper）
- [x] 重複排除ロジックのテスト実装（7テスト全て合格）
- [x] 既存データの重複チェック実行（重複なし確認）

## 他の都道府県のスクレイピング追加（追加要望）
- [x] 追加対象都道府県の選定（出没件数、データ取得難易度、優先度を考慮）
- [x] 北海道ひぐまっぷのデータ構造調査（APIの有無不明、保留）
- [ ] 北海道ひぐまっぷのスクレイピング実装（保留：API確認後）
- [x] 京都府GISデータの構造調査（利用規約でスクレイピング禁止）
- [ ] 京都府GISデータのスクレイピング実装（実装不可：法的リスク）
- [x] くまっぷ（Xenon）の調査（公式API提供、テナント申請が必要）
- [ ] くまっぷテナント申請提出
- [ ] くまっぷAPI統合実装（承認後）
- [ ] OpenAPI Generatorでクライアントコード生成
- [ ] くまっぷデータ変換ロジック実装
- [ ] 自動実行スケジュールへの統合（毎日午前3時）
- [ ] テスト実装と動作確認

## くまっぷAPI統合実装（追加要望）
- [x] OpenAPI仕様書をダウンロード（docs/kumap-openapi.yaml）
- [x] 環境変数KUMAP_API_KEYの設定
- [x] くまっぷAPIクライアントラッパー実装（server/kumapClient.ts）
- [x] くまっぷデータ取得ロジック実装（server/kumapScraper.ts）
- [x] データ変換ロジック実装（くまっぷ形式 → bearSightings形式）
- [x] 重複排除ロジックの適用
- [x] scraperRouterにくまっぷスクレイパー追加（runKumapScraper）
- [x] 自動実行スクリプト作成（scripts/run-kumap-scraper.mjs）
- [x] テスト実装（kumapClient.test.ts, kumapScraper.test.ts）
- [x] 実際のデータインポート実行と確認（1,213件インポート成功、合計1,635件）

## 完全自動化と更新時刻表示（追加要望）
- [x] 毎日定刻に自動実行するスケジュール設定（毎日午前2時にくまっぷAPI、長野県PDF、Yahoo!リンクを自動実行）
- [x] サイトに「毎日午前2時に自動更新」と明記（Footer.tsxに追加）
- [x] 登録なしで閲覧可能であることを確認（publicProcedureで実装済み）
- [x] テストと動作確認（1,635件のデータが地図に表示されることを確認）

## 危険度ヒートマップ実装（追加要望）
- [x] Google Mapsヒートマップライブラリの調査と導入（visualizationライブラリ追加）
- [x] ヒートマップコンポーネントの実装（MapView.tsxに統合）
- [x] MapViewへのヒートマップ統合（表示切替機能付き）
- [x] テストと動作確認

## LINE通知機能実装（後回し）
- [ ] LINE Messaging APIの調査と設定
- [ ] LINE通知サービスの実装
- [ ] ユーザーのLINE連携設定画面
- [ ] 新規出没情報時のLINE通知送信

## ダークモード実装（追加要望）
- [x] ダークモード切り替えボタンの追加（ThemeToggle.tsx）
- [x] ダークモード用のスタイル調整（MapView, About, Footer）
- [x] テストと動作確認

## ユーザーガイド・データソース説明ページ（追加要望）
- [x] Aboutページの作成（サイト説明、使い方）
- [x] データソースの詳細説明
- [x] ナビゲーションにリンク追加

## メール通知機能実装（追加要望）
- [x] email_subscriptionsテーブル作成（メールアドレス、都道府県、確認トークン、確認状態）
- [x] メール送信機能の実装（Gmail MCP使用）
- [x] 通知設定ページの改修（メールアドレス入力フォーム追加）
- [x] ダブルオプトイン実装（確認メール送信）
- [x] 迷惑フォルダ注意メッセージの表示
- [x] 解除リンク機能の実装（メール内に解除リンク）
- [x] 通知サービスの修正（実際のメール送信）
- [ ] Gmail MCP接続後のテスト

## Aboutページ改善（追加要望）
- [x] 通知機能の説明を追加
- [x] ログイン機能の記載を削除・修正
- [x] 高齢者向けの分かりやすい説明に改善

## 初回訪問時ポップアップ機能（追加要望）
- [x] クマに出会った時の対応方法・注意点を表示
- [x] 行政への連絡のお願いを表示
- [x] 本サイトへの投稿のお願いを表示
- [x] 「了解しました」ボタンで閉じる機能
- [x] localStorageで表示済みフラグを管理

## ロゴ追加（追加要望）
- [x] ロゴ画像をpublicフォルダにコピー
- [x] ヘッダー左側にロゴを表示
- [x] ファビコンとしてHTMLに設定

## フィルター機能拡張（追加要望）
- [x] 複数都道府県の同時選択機能
- [x] カスタム日付範囲の指定機能（開始日・終了日）
- [x] MapViewへの統合
- [x] テストと動作確認

## スマホ向けレスポンシブ最適化（追加要望）
- [x] MapViewのモバイル最適化（地図を画面いっぱいに表示）
- [x] フィルターのモバイル用UI（コンパクト化、ハンバーガーメニュー）
- [x] ヘッダーのモバイル対応（ハンバーガーメニュー）
- [x] フッターのモバイル対応
- [x] タッチ操作しやすいマーカーサイズ
- [x] その他ページのモバイル対応
- [x] テストと動作確認

## 統計ページのモバイル最適化（追加要望）
- [x] グラフのモバイル最適化（サイズ調整、横スクロール対応）
- [x] 表のモバイル最適化（横スクロール、カード表示）
- [x] レイアウトの調整（パディング、マージン）
- [x] テストと動作確認

## クマ被害防止機能（追加要望）
- [x] 緊急対策ページの作成（遭遇時の詳細ガイド）
- [x] メール通知の改善（注意喚起メッセージと対処法リンク追加）
- [x] 地域別緊急連絡先一覧ページの作成
- [x] ナビゲーションへの統合
- [x] テストと動作確認

## ホームボタン追加（追加要望）
- [x] ロゴ/クマップクリックでホームに戻る機能を確認
- [x] ナビゲーションに「ホーム」ボタンを追加

## 季節別注意喚起バナー（追加要望）
- [x] 春（冬眠明け3-5月）の注意喚起バナー
- [x] 秋（冬眠前9-11月）の注意喚起バナー
- [x] 夏（繁殖期6-8月）の注意喚起バナー
- [x] 「×」ボタンで閉じる機能
- [x] sessionStorageで閉じた状態を保持

## 通知設定ページの簡素化（追加要望）
- [x] アプリ通知（要ログイン）タブを削除
- [x] メール通知のみのシンプルなページに変更


## GPS連携による現在地周辺危険度表示機能（追加要望）
- [x] コアユーティリティ実装
  - [x] Haversine距離計算関数（client/src/lib/geoUtils.ts）
  - [x] 逆ジオコーディング（座標→都道府県）
  - [x] 都道府県境界データ（PREFECTURE_BOUNDS in geoUtils.ts）
- [x] Service Worker・キャッシュ戦略
  - [x] 都道府県別データキャッシュ（client/public/sw.js）
  - [x] オフライン対応
  - [x] キャッシュ更新ロジック
- [x] GPS危険度コンポーネント
  - [x] NearbyDangerIndicator.tsx
  - [x] 位置情報取得フック（useGeolocation.ts）
  - [x] 危険度計算ロジック
- [x] 関連ページへの統合
  - [x] MapView.tsx（メインマップ）
  - [x] About.tsx（機能説明追加）
  - [x] EmergencyGuide.tsx（緊急対策ページ）
- [x] プライバシー同意UI
  - [x] LocationConsentModal.tsx
  - [x] 同意状態の管理（localStorage）
  - [x] 設定画面での無効化オプション
- [x] オフライン対応・テスト
  - [x] オフライン時の表示（キャッシュデータ使用）
  - [x] データ鮮度の警告表示
  - [x] テスト実装（geoUtils.test.ts - 28テスト全て合格）
